<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gonzalo Díaz-Heredero López | Especialista en Fiscalidad Internacional y DTAs</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tipografía Clásica: Merriweather para títulos y serif en general */
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&display=swap');
        
        body {
            /* Fondo de Pergamino sutil */
            background-color: #fcfbf5; 
            color: #3e3e3e; /* Tinta oscura */
            font-family: 'Merriweather', serif; /* Fuente principal con serifa */
        }
        h1, h2, h3 {
            font-family: 'Merriweather', serif;
            font-weight: 700;
            color: #1a2a47; /* Azul profundo (Navy Clásico) */
        }
        /* Color de acento: Un tono de oro/bronce para destacar elementos */
        .accent-color {
            color: #8b5e3c; /* Tono Bronce/Cobre */
        }
        /* Sidebar (Aspecto de Lomo de Libro o Mármol) */
        .sidebar-bg {
            background-color: #1a2a47; /* Navy profundo */
            box-shadow: 6px 0 15px -3px rgba(0, 0, 0, 0.3);
        }
        /* Contenido principal */
        main {
            border-left: 2px solid #ddd;
        }
        /* Estilo de línea divisoria que simula una ornamentación clásica */
        .classic-divider {
            border-bottom: 3px double #b0b0b0;
            padding-bottom: 2rem;
            margin-bottom: 2rem;
        }
        .clickable-specialty {
            cursor: pointer;
            transition: color 0.2s;
        }
        .clickable-specialty:hover {
            color: #8b5e3c; /* Cambia a color acento al pasar el ratón */
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <!-- Menú Sidebar Fijo (Índice Funcional y Riguroso) -->
    <nav id="sidebar" class="sidebar-bg w-64 fixed h-full flex flex-col justify-start pt-12 text-white z-20">
        <div class="px-6 pb-8 border-b border-[#304d7c]">
            <h2 class="text-2xl font-black tracking-widest text-[#f5d79e] leading-none">LEX</h2>
            <p class="text-sm mt-1 text-gray-300">Gonzalo D. H. López</p>
        </div>
        
        <!-- Índice Funcional (Navegación por Anclas) -->
        <div class="flex flex-col p-4 space-y-2 mt-4">
            <a href="#inicio" class="p-3 rounded-none hover:bg-[#304d7c] transition duration-150 text-base font-medium border-l-4 border-transparent hover:border-[#f5d79e]">
                <span class="accent-color mr-2">/</span> Presentación
            </a>
            <a href="#rigor" class="p-3 rounded-none hover:bg-[#304d7c] transition duration-150 text-base font-medium border-l-4 border-transparent hover:border-[#f5d79e]">
                <span class="accent-color mr-2">/</span> Prestigio y Doctrinal
            </a>
            <a href="#competencias" class="p-3 rounded-none hover:bg-[#304d7c] transition duration-150 text-base font-medium border-l-4 border-transparent hover:border-[#f5d79e]">
                <span class="accent-color mr-2">/</span> Especialización
            </a>
            <a href="#legaltech" class="p-3 rounded-none hover:bg-[#304d7c] transition duration-150 text-base font-medium border-l-4 border-transparent hover:border-[#f5d79e]">
                <span class="accent-color mr-2">/</span> Clarificación Doctrinal ✨
            </a>
            <a href="#servicios" class="p-3 rounded-none hover:bg-[#304d7c] transition duration-150 text-base font-medium border-l-4 border-transparent hover:border-[#f5d79e]">
                <span class="accent-color mr-2">/</span> Dictámenes
            </a>
            <a href="#publicaciones" class="p-3 rounded-none hover:bg-[#304d7c] transition duration-150 text-base font-medium border-l-4 border-transparent hover:border-[#f5d79e]">
                <span class="accent-color mr-2">/</span> Trabajos Analíticos
            </a>
            <a href="#contacto" class="p-3 rounded-none hover:bg-[#304d7c] transition duration-150 text-base font-medium border-l-4 border-transparent hover:border-[#f5d79e]">
                <span class="accent-color mr-2">/</span> Contacto y Fuero
            </a>
        </div>
    </nav>

    <!-- Contenido Principal (Margen a la izquierda para el sidebar: ml-64) -->
    <main class="ml-64 p-8 md:p-12 lg:p-16 text-gray-800">

        <!-- *************** VISTA PRINCIPAL (HOME) *************** -->
        <div id="homeView">
            <!-- Sección #Inicio: Presentación y Título -->
            <section id="inicio" class="classic-divider">
                <header class="mb-6">
                    <p class="text-sm tracking-wider uppercase text-gray-500 mb-1">Fiscalidad Internacional y Análisis de Movilidad</p>
                    <h1 class="text-4xl md:text-5xl font-extrabold leading-snug text-gray-900">
                        Gonzalo Díaz-Heredero López | Especialista en Fiscalidad Internacional y Convenios de Doble Imposición.
                    </h1>
                    <p class="text-2xl mt-4 font-light accent-color italic">Dictámenes Técnicos sobre Expatriados, Impatriados y Aplicación de DTAs, con soporte LegalTech.</p>
                </header>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <p class="text-lg text-gray-700 leading-relaxed font-serif">
                        Mi servicio de Consultoría Técnica-Jurídica está enfocado en la alta especialización en <span class="font-bold">Fiscalidad Internacional</span>, proporcionando a despachos y consultoras un análisis fiscal que combina el rigor doctrinal (UCM, ISDE) con metodologías innovadoras (LegalTech en DTAs), garantizando la seguridad jurídica en la tributación de la movilidad de personas físicas.
                    </p>
                </div>
            </section>

            <!-- Sección #Rigor: Validación de Premios -->
            <section id="rigor" class="pt-8 classic-divider">
                <h2 class="text-3xl font-bold mb-6 border-b pb-2 border-gray-300">Fundamento Doctrinal y Prestigio Académico</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Premio ISDE (Rigor Legal) -->
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-amber-600">
                        <p class="text-xl font-bold mb-1 text-gray-900">XV Premio Jurídico Internacional ISDE 2025</p>
                        <p class="text-base accent-color mb-3 font-semibold">Validación en LIRPF y Exención del Art. 7.p</p>
                        <p class="text-gray-700 leading-relaxed text-sm font-serif">
                            Distinción que avala el dominio exhaustivo de la <span class="font-bold">exención del artículo 7.p LIRPF</span>, esencial para la planificación de la movilidad laboral de <span class="font-bold">expatriados</span> y el análisis de rendimientos de trabajo obtenidos en el extranjero.
                        </p>
                    </div>
                    <!-- Premio UCM (Innovación LegalTech) -->
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-amber-600">
                        <p class="text-xl font-bold mb-1 text-gray-900">Premio Emprendimiento Universitario UCM 2025</p>
                        <p class="text-base accent-color mb-3 font-semibold">Aplicación de LegalTech al Análisis de DTAs</p>
                        <p class="text-gray-700 leading-relaxed text-sm font-serif">
                            Reconocimiento a la metodología que integra <span class="font-bold">IA (GPT-4o)</span> para identificar patrones atípicos en <span class="font-bold">Convenios de Doble Imposición (DTAs)</span>, ofreciendo una ventaja analítica inigualable en la resolución de conflictos internacionales.
                        </p>
                    </div>
                </div>
            </section>
            
            <!-- Sección #Competencias: Desglose de Impuestos Asesorables y Enfoque Movilidad -->
            <section id="competencias" class="pt-8 classic-divider">
                <h2 class="text-3xl font-bold mb-6 border-b pb-2 border-gray-300">Especialización Estratégica en Movilidad y Tributación Global</h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Área 1: Movilidad y LIRPF (CLICKABLE) -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 hover:shadow-xl transition duration-300 clickable-specialty" onclick="showDetail('specialty1')">
                        <h3 class="text-xl font-bold text-gray-900 mb-3 border-b border-gray-200 pb-1 accent-color">Especialidad I: Impatriados y Expatriados</h3>
                        <ul class="space-y-3 text-gray-700 font-serif ml-4 list-disc list-inside">
                            <li><span class="font-bold">Impatriados (Ley Beckham):</span> Análisis de acceso, cumplimiento de requisitos y obligaciones fiscales.</li>
                            <li><span class="font-bold">Expatriados:</span> Aplicación y defensa de la Exención del Art. 7.p LIRPF por trabajos en el extranjero.</li>
                            <li><span class="font-bold">Residencia Fiscal:</span> Dictámenes sobre el criterio de permanencia y el centro de intereses vitales.</li>
                        </ul>
                    </div>
                    <!-- Área 2: Fiscalidad Internacional y Análisis de Riesgos (CLICKABLE) -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 hover:shadow-xl transition duration-300 clickable-specialty" onclick="showDetail('specialty2')">
                        <h3 class="text-xl font-bold text-gray-900 mb-3 border-b border-gray-200 pb-1 accent-color">Especialidad II: Convenios de Doble Imposición (CDI)</h3>
                        <ul class="space-y-3 text-gray-700 font-serif ml-4 list-disc list-inside">
                            <li><span class="font-bold">Interpretación de CDI:</span> Aplicación del Modelo OCDE y análisis comparado de cláusulas.</li>
                            <li><span class="font-bold">Métodos para Evitar la Doble Imposición:</span> Determinación del método aplicable (exención o deducción).</li>
                            <li><span class="font-bold">Análisis LegalTech en DTAs:</span> Uso de IA para la detección de divergencias y optimización del análisis.</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Desglose General de Impuestos -->
                <div class="mt-8">
                    <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2 border-gray-300">Otras Competencias Fiscales (Tributos Generales)</h3>
                    <ul class="grid md:grid-cols-2 gap-x-8 gap-y-3 text-gray-700 font-serif ml-4 list-disc list-inside">
                        <li><span class="font-semibold">Impuesto sobre Sociedades (IS)</span> y planificación corporativa.</li>
                        <li><span class="font-semibold">Impuesto sobre la Renta de No Residentes (IRNR).</span></li>
                        <li><span class="font-semibold">IVA</span>: Operaciones intragrupo (doctrina TJUE), intracomunitarias y servicios.</li>
                        <li><span class="font-semibold">Impuesto sobre el Patrimonio (IP)</span> e Impuesto sobre Sucesiones y Donaciones (ISD).</li>
                    </ul>
                </div>
            </section>

            <!-- Sección #LegalTech: Herramienta LLM -->
            <section id="legaltech" class="pt-8 classic-divider">
                <h2 class="text-3xl font-bold mb-6 border-b pb-2 border-gray-300">Herramienta de Clarificación Doctrinal LegalTech ✨</h2>
                <div class="bg-gray-100 p-6 rounded-lg shadow-inner border border-gray-300">
                    <p class="text-lg text-gray-700 leading-relaxed font-serif mb-4">
                        Utilice nuestro módulo avanzado (impulsado por Gemini) para obtener una definición inmediata y rigurosa de cualquier concepto complejo en Fiscalidad Internacional, con referencias académicas y normativas actuales.
                    </p>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="conceptInput" placeholder="Ej: Establecimiento Permanente, BEPS, Artículo 7.p LIRPF" 
                            class="flex-grow p-3 border border-gray-400 rounded-lg focus:ring-[#1a2a47] focus:border-[#1a2a47] font-serif text-gray-800 shadow-sm"
                            value="">
                        <button id="clarifyButton" 
                                class="bg-[#1a2a47] text-[#fcfbf5] font-bold py-3 px-6 rounded-lg hover:bg-[#304d7c] transition duration-200 shadow-md">
                            ✨ Obtener Clarificación Doctrinal
                        </button>
                    </div>
                    
                    <div id="resultArea" class="mt-6 hidden bg-white p-4 rounded-lg border border-amber-600 shadow-lg">
                        <p id="resultText" class="text-gray-800 leading-relaxed font-serif"></p>
                        <div id="sourcesArea" class="mt-4 pt-2 border-t border-gray-200 text-xs text-gray-500 italic"></div>
                        <p id="loadingIndicator" class="text-center text-gray-600 italic hidden">Analizando doctrina... por favor, espere.</p>
                    </div>
                </div>
            </section>

            <!-- Sección #Servicios: Tipos de Dictámenes -->
            <section id="servicios" class="pt-8 classic-divider">
                <h2 class="text-3xl font-bold mb-6 border-b pb-2 border-gray-300">Objeto de la Consultoría: Dictámenes y Opiniones Legales</h2>
                <div class="grid md:grid-cols-3 gap-8 text-center">
                    <!-- Servicio 1: Dictámenes 7.p / Impatriados -->
                    <div class="bg-gray-100 p-6 rounded-lg shadow-inner">
                        <p class="accent-color text-4xl mb-3">I.</p>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Dictamen de Movilidad Internacional</h3>
                        <p class="text-sm text-gray-700 font-serif">Análisis de la correcta aplicación del Régimen de Impatriados o la Exención del Art. 7.p, clave para la seguridad jurídica del trabajador.</p>
                    </div>
                    <!-- Servicio 2: Análisis CDI con AI Support -->
                    <div class="bg-gray-100 p-6 rounded-lg shadow-inner">
                        <p class="accent-color text-4xl mb-3">II.</p>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Resolución de Conflictos de Doble Imposición</h3>
                        <p class="text-sm text-gray-700 font-serif">Determinación de la potestad tributaria entre Estados, apoyado en el análisis comparado y LegalTech para identificar riesgos.</p>
                    </div>
                    <!-- Servicio 3: Soporte Procesal -->
                    <div class="bg-gray-100 p-6 rounded-lg shadow-inner">
                        <p class="accent-color text-4xl mb-3">III.</p>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Soporte Técnico Inter-Firma</h3>
                        <p class="text-sm text-gray-700 font-serif">Elaboración de informes de alto valor probatorio como apoyo documental a la defensa procesal en recursos y reclamaciones económico-administrativas.</p>
                    </div>
                </div>
            </section>

            <!-- Sección #Publicaciones: Muestras de la capacidad analítica (Contenido real) -->
            <section id="publicaciones" class="pt-8 classic-divider">
                <h2 class="text-3xl font-bold mb-6 border-b pb-2 border-gray-300">Trabajos Analíticos y Publicaciones Doctrinales</h2>
                <div class="space-y-5">
                    <!-- Publicación 1: AI en TFG Fiscal -->
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                        <p class="text-lg font-semibold text-gray-900 accent-color italic">Artículo Doctrinal:</p>
                        <p class="font-bold text-gray-800 text-lg mt-1">Evaluación de la IA como herramienta durante el TFG de ámbito fiscal, ¿complemento o sustituto del estudiante?</p>
                        <p class="text-sm text-gray-600 mt-2">Publicado en la revista <span class="font-semibold">e-pública (Septiembre 2025)</span>. Se analiza la integración de la IA en tareas de análisis comparado de textos normativos fiscales.</p>
                    </div>
                    <!-- Publicación 2: IVA Intragrupo -->
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                        <p class="text-lg font-semibold text-gray-900 accent-color italic">Nota de Jurisprudencia:</p>
                        <p class="font-bold text-gray-800 text-lg mt-1">IVA en operaciones intragrupo: últimas reflexiones del TJUE</p>
                        <p class="text-sm text-gray-600 mt-2">Artículo en <span class="font-semibold">LEX - EL PORTAL JURÍDICO HISPANO-ALEMÁN (Febrero 2025)</span>. Revisión de la doctrina del Tribunal de Justicia de la Unión Europea sobre la sujeción a IVA.</p>
                    </div>
                </div>
            </section>

            <!-- Sección #Contacto: Datos y el aviso de no colegiación (OBLIGATORIO) -->
            <section id="contacto" class="pt-8 pb-8">
                <h2 class="text-3xl font-bold mb-6 border-b pb-2 border-gray-300">Contacto y Fuero del Servicio</h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Datos de Contacto -->
                    <div class="bg-gray-100 p-6 rounded-lg shadow-xl border border-gray-300">
                        <h3 class="text-2xl font-bold accent-color mb-3">Solicitud de Análisis</h3>
                        <p class="mt-4 text-gray-700 font-serif">
                            <span class="font-bold text-gray-900">Correo Electrónico:</span> contacto@diazheredero.es (Ejemplo)
                        </p>
                        <p class="mt-2 text-gray-700 font-serif">
                            <span class="font-bold text-gray-900">Perfil Profesional:</span> Gonzalo Díaz-Heredero López
                        </p>
                        <p class="mt-4 text-gray-700 text-sm font-serif italic">
                            El primer contacto debe describir concisamente la cuestión fiscal y el marco legal que requiere el dictamen.
                        </p>
                    </div>

                    <!-- Aviso de No Colegiación (Requisito OBLIGATORIO, estilo serio) -->
                    <div class="bg-red-50 p-6 rounded-lg border-l-4 border-red-700 shadow-xl">
                        <h3 class="text-2xl font-bold text-red-800 mb-3">Advertencia Legal: Limitación de Servicios</h3>
                        <p class="text-lg text-gray-800 font-serif">
                            Gonzalo Díaz-Heredero López presta servicios de <span class="font-bold">Análisis Técnico-Jurídico</span> (Dictámenes e Informes especializados).
                        </p>
                        <p class="text-xl text-red-700 mt-3 font-extrabold">
                            No está colegiado para ejercer la defensa o representación legal en procedimientos judiciales.
                        </p>
                        <p class="text-sm text-gray-600 mt-3 font-serif">
                            Mis informes están destinados a servir de apoyo documental y soporte estratégico al profesional o firma que ejerce la representación procesal del cliente.
                        </p>
                    </div>
                </div>

                <!-- NUEVO: Asistente de Solicitud Formal LLM -->
                <div class="mt-8 bg-white p-6 rounded-lg shadow-xl border border-gray-200">
                    <h3 class="text-2xl font-bold text-[#1a2a47] mb-3 border-b pb-2 accent-color">Asistente de Solicitud Formal ✨</h3>
                    <p class="text-lg text-gray-700 font-serif mb-4">
                        Utilice esta herramienta (impulsada por Gemini) para generar un borrador estructurado de su solicitud de dictamen, listo para copiar y enviar por email.
                    </p>
                    <div class="space-y-4">
                        <select id="requestTopic" class="w-full p-3 border border-gray-400 rounded-lg font-serif text-gray-800 shadow-sm focus:ring-[#1a2a47] focus:border-[#1a2a47]">
                            <option value="" disabled selected>Seleccione el tema principal...</option>
                            <option value="Régimen de Impatriados (Ley Beckham)">Régimen de Impatriados (Ley Beckham)</option>
                            <option value="Exención por trabajos en el extranjero (Art. 7.p LIRPF)">Exención Art. 7.p LIRPF</option>
                            <option value="Aplicación de Convenio de Doble Imposición (CDI)">Aplicación de Convenio de Doble Imposición (CDI)</option>
                            <option value="Conflicto de residencia fiscal">Conflicto de Residencia Fiscal</option>
                            <option value="Otras cuestiones de fiscalidad internacional">Otras Cuestiones de Fiscalidad Internacional</option>
                        </select>
                        <textarea id="requestDetails" rows="4" placeholder="Describa brevemente su caso y la cuestión a resolver (Ej: 'Soy un ciudadano mexicano que será trasladado a Madrid por 3 años para trabajar en la filial española. Deseo saber si aplico a la Ley Beckham y los plazos.')." 
                            class="w-full p-3 border border-gray-400 rounded-lg focus:ring-[#1a2a47] focus:border-[#1a2a47] font-serif text-gray-800 shadow-sm"></textarea>
                        <button id="draftButton" class="bg-amber-600 text-[#1a2a47] font-bold py-3 px-6 rounded-lg hover:bg-amber-700 transition duration-200 shadow-md w-full">
                            ✨ Generar Borrador Formal
                        </button>
                    </div>
                    
                    <div id="draftResultArea" class="mt-6 hidden bg-gray-50 p-4 rounded-lg border border-gray-400 shadow-inner">
                        <h4 class="font-bold text-gray-900 mb-2">Borrador de Solicitud (Cuerpo de Email):</h4>
                        <!-- El uso de <pre> preserva el formato del LLM (saltos de línea) -->
                        <pre id="draftText" class="whitespace-pre-wrap text-sm text-gray-800 bg-white p-3 border rounded font-mono overflow-auto"></pre>
                        <button id="copyDraftButton" class="mt-3 bg-[#1a2a47] text-[#fcfbf5] font-bold py-2 px-4 rounded-lg hover:bg-[#304d7c] transition duration-200 shadow-md text-sm">
                            Copiar al Portapapeles
                        </button>
                    </div>
                    <p id="draftLoadingIndicator" class="text-center text-gray-600 italic hidden mt-4">Redactando borrador formal... por favor, espere.</p>
                </div>

            </section>
        </div>
        <!-- *************** FIN VISTA PRINCIPAL (HOME) *************** -->


        <!-- *************** VISTA DETALLE 1: Impatriados y Expatriados *************** -->
        <div id="specialty1Detail" class="hidden">
            <button onclick="showHome()" class="mb-8 bg-gray-200 text-[#1a2a47] font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                ← Volver a Especialización Principal
            </button>
            <h1 class="text-4xl md:text-5xl font-extrabold leading-snug text-[#1a2a47] classic-divider mb-8">
                Especialidad I: Movilidad Fiscal (Expatriados e Impatriados)
            </h1>

            <div class="space-y-12">
                <!-- Art. 7.p LIRPF (Expatriados) -->
                <div class="bg-white p-8 rounded-lg shadow-xl border-l-4 border-amber-600">
                    <h2 class="text-3xl font-bold mb-4 accent-color">Exención por Trabajos en el Extranjero (Art. 7.p LIRPF)</h2>
                    <p class="text-lg text-gray-700 leading-relaxed font-serif mb-4">
                        La correcta aplicación de esta exención es crítica para reducir la factura fiscal de los <span class="font-bold">expatriados</span>. Mi análisis se centra en el cumplimiento estricto de los tres requisitos acumulativos clave:
                    </p>
                    <ul class="list-disc ml-6 space-y-2 text-gray-700 font-serif">
                        <li>Existencia de un desplazamiento efectivo al extranjero.</li>
                        <li>Los trabajos deben realizarse para una entidad no residente o para un Establecimiento Permanente (EP) español en el extranjero.</li>
                        <li>Existencia de un impuesto similar en el país de destino (criterio de tributación efectiva).</li>
                    </ul>
                    <p class="text-md text-gray-600 mt-4 italic">
                        Realizo dictámenes con valoración de riesgo en situaciones de <span class="font-semibold">desplazamientos cortos</span>, <span class="font-semibold">grupos empresariales</span> y situaciones de <span class="font-semibold">teletrabajo</span> internacional, donde la Agencia Tributaria tiene mayor foco.
                    </p>
                </div>

                <!-- Ley Beckham (Impatriados) -->
                <div class="bg-white p-8 rounded-lg shadow-xl border-l-4 border-[#1a2a47]">
                    <h2 class="text-3xl font-bold mb-4 accent-color">Régimen Especial de Impatriados (Ley Beckham)</h2>
                    <p class="text-lg text-gray-700 leading-relaxed font-serif mb-4">
                        Este régimen ofrece una atractiva tributación como no residente (tipo fijo del 24%) a pesar de residir en España. Sin embargo, su aplicación está sujeta a requisitos temporales y funcionales estrictos.
                    </p>
                    <ul class="list-disc ml-6 space-y-2 text-gray-700 font-serif">
                        <li>No haber sido residente fiscal en España en los 5 años anteriores.</li>
                        <li>Desplazamiento por contrato de trabajo o adquisición de participación.</li>
                        <li>Comunicación a la AEAT dentro del plazo legal.</li>
                    </ul>
                    <p class="text-md text-gray-600 mt-4 italic">
                        Mi servicio incluye la verificación del cumplimiento de los requisitos de la <span class="font-semibold">Orden HFP/1335/2023</span> y la planificación de la <span class="font-semibold">fecha de solicitud</span> y exclusión del régimen.
                    </p>
                </div>
            </div>
            <button onclick="showHome()" class="mt-12 bg-gray-200 text-[#1a2a47] font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                ← Volver a Especialización Principal
            </button>
        </div>
        <!-- *************** FIN VISTA DETALLE 1 *************** -->


        <!-- *************** VISTA DETALLE 2: Convenios de Doble Imposición (CDI) *************** -->
        <div id="specialty2Detail" class="hidden">
            <button onclick="showHome()" class="mb-8 bg-gray-200 text-[#1a2a47] font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                ← Volver a Especialización Principal
            </button>
            <h1 class="text-4xl md:text-5xl font-extrabold leading-snug text-[#1a2a47] classic-divider mb-8">
                Especialidad II: Convenios de Doble Imposición (CDI) y Modelo OCDE
            </h1>

            <div class="space-y-12">
                <!-- Modelo OCDE y Novedades -->
                <div class="bg-white p-8 rounded-lg shadow-xl border-l-4 border-amber-600">
                    <h2 class="text-3xl font-bold mb-4 accent-color">Interpretación del Modelo de Convenio OCDE</h2>
                    <p class="text-lg text-gray-700 leading-relaxed font-serif mb-4">
                        La interpretación de los <span class="font-bold">CDI</span> se realiza conforme al Modelo OCDE y sus Comentarios, fundamentales para determinar la potestad tributaria.
                    </p>
                    <ul class="list-disc ml-6 space-y-2 text-gray-700 font-serif">
                        <li>Aplicación de las 'Tie-breaker Rules' (Reglas de desempate) para personas físicas.</li>
                        <li>Análisis del Art. 7 (Beneficios Empresariales) y Art. 15 (Rendimientos del Empleo).</li>
                        <li>Impacto de la acción <span class="font-semibold">BEPS (Base Erosion and Profit Shifting)</span> y el Instrumento Multilateral (MLI) en los CDI bilaterales.</li>
                    </ul>
                    <p class="text-md text-gray-600 mt-4 italic">
                        Utilizamos LegalTech para contrastar las versiones más recientes de los Comentarios OCDE con la redacción específica del CDI aplicable (p.ej., España-EE. UU. o España-Reino Unido).
                    </p>
                </div>

                <!-- Métodos de Eliminación -->
                <div class="bg-white p-8 rounded-lg shadow-xl border-l-4 border-[#1a2a47]">
                    <h2 class="text-3xl font-bold mb-4 accent-color">Métodos de Eliminación de la Doble Imposición</h2>
                    <p class="text-lg text-gray-700 leading-relaxed font-serif mb-4">
                        La correcta selección del método de eliminación es la clave para la tributación final:
                    </p>
                    <div class="grid md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <h4 class="font-bold text-gray-900 text-xl mb-1">Método de Exención</h4>
                            <p class="text-sm text-gray-700 font-serif">
                                Aplicación para ciertos tipos de renta donde el país de residencia no grava la renta obtenida en el extranjero, o lo hace con progresividad (exención con progresión).
                            </p>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900 text-xl mb-1">Método de Deducción</h4>
                            <p class="text-sm text-gray-700 font-serif">
                                El país de residencia deduce el impuesto pagado en el otro Estado, con la limitación de la cuota interna española. Análisis del límite y el cálculo óptimo.
                            </p>
                        </div>
                    </div>
                    <p class="text-md text-gray-600 mt-4 italic">
                        Dictámenes técnicos sobre si la aplicación del CDI es preferible a la deducción por doble imposición internacional prevista en la legislación interna española (LIRPF).
                    </p>
                </div>
            </div>
            <button onclick="showHome()" class="mt-12 bg-gray-200 text-[#1a2a47] font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                ← Volver a Especialización Principal
            </button>
        </div>
        <!-- *************** FIN VISTA DETALLE 2 *************** -->
        
        <!-- Footer (siempre visible en el fondo de MAIN) -->
        <footer class="mt-16 pt-8 border-t-4 border-double border-gray-400 text-center text-sm text-gray-500 font-serif">
            <p>&copy; 2025 G. D. H. L. | Consultoría Técnica. Rigor y Metodología en Derecho Tributario.</p>
        </footer>
    </main>

    <script>
        // Función para cambiar entre vistas
        function showDetail(detailId) {
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('specialty1Detail').classList.add('hidden');
            document.getElementById('specialty2Detail').classList.add('hidden');
            
            if (detailId === 'specialty1') {
                document.getElementById('specialty1Detail').classList.remove('hidden');
                window.scrollTo(0, 0); // Ir arriba
            } else if (detailId === 'specialty2') {
                document.getElementById('specialty2Detail').classList.remove('hidden');
                window.scrollTo(0, 0); // Ir arriba
            }
        }

        // Función para volver a la vista principal
        function showHome() {
            document.getElementById('specialty1Detail').classList.add('hidden');
            document.getElementById('specialty2Detail').classList.add('hidden');
            document.getElementById('homeView').classList.remove('hidden');
            window.location.hash = '#competencias'; // Intentar volver a la sección de competencias
        }


        // **************** LÓGICA DE CLARIFICACIÓN DOCTRINAL (GEMINI API) ****************
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('conceptInput');
            const clarifyButton = document.getElementById('clarifyButton');
            const resultArea = document.getElementById('resultArea');
            const resultText = document.getElementById('resultText');
            const sourcesArea = document.getElementById('sourcesArea');
            const loadingIndicator = document.getElementById('loadingIndicator');

            const requestTopic = document.getElementById('requestTopic');
            const requestDetails = document.getElementById('requestDetails');
            const draftButton = document.getElementById('draftButton');
            const draftResultArea = document.getElementById('draftResultArea');
            const draftText = document.getElementById('draftText');
            const draftLoadingIndicator = document.getElementById('draftLoadingIndicator');
            const copyDraftButton = document.getElementById('copyDraftButton');

            const apiKey = ""; // API key is provided at runtime in Canvas environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // Configuración del sistema para Gemini (persona y tono)
            const clarificationSystemPrompt = "Actúa como un experto en Derecho Tributario Internacional con profundo rigor académico. Proporciona una definición concisa (máximo 4 frases) y académicamente rigurosa del concepto legal solicitado, fundamentado en doctrina y normativa actual. El tono debe ser formal y autoritario.";
            const draftingSystemPrompt = "Actúa como un asistente legal que convierte notas breves en un borrador de email formal y conciso para solicitar un dictamen a un especialista en Derecho Tributario. El borrador debe comenzar con un 'Asunto:' seguido de un salto de línea, y luego el cuerpo del mensaje estructurado con un 'Estimado/a colega' o similar y párrafos para 'Antecedentes' y 'Cuestión a resolver'. Concluye con un 'Atentamente, [Su Nombre]'. No utilices fuentes externas, solo la información proporcionada por el usuario. El borrador debe ser profesional y directo. NO utilices fuentes externas.";

            /**
             * Retries an async function with exponential backoff.
             */
            const withBackoff = async (fn, retries = 5, delay = 1000) => {
                try {
                    return await fn();
                } catch (error) {
                    if (retries === 0) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return withBackoff(fn, retries - 1, delay * 2);
                }
            };
            
            // ************ Función: Clarificación Doctrinal ************
            const getClarification = async () => {
                const concept = input.value.trim();
                if (!concept) {
                    resultText.innerHTML = '<span class="text-red-600 font-bold">Error:</span> Por favor, introduzca un concepto a clarificar.';
                    resultArea.classList.remove('hidden');
                    return;
                }

                resultArea.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                clarifyButton.disabled = true;

                const userQuery = `Definición y marco legal de: "${concept}"`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    // Habilitar Google Search Grounding para fundamentar la respuesta
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: clarificationSystemPrompt }]
                    },
                };

                try {
                    const response = await withBackoff(async () => {
                        return await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        resultText.innerHTML = `<span class="font-bold accent-color">Concepto: ${concept}</span><br><br>${text}`;

                        // Extracción de las fuentes (citations)
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        if (sources.length > 0) {
                            let sourcesHtml = 'Fuentes consultadas (LegalTech Grounding):<ul class="list-disc ml-5 mt-1 space-y-1">';
                            // Usar un Set para garantizar fuentes únicas por URI
                            const uniqueUris = new Set();
                            sources.forEach(source => {
                                if (!uniqueUris.has(source.uri)) {
                                    sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="hover:text-[#1a2a47] hover:underline">${source.title}</a></li>`;
                                    uniqueUris.add(source.uri);
                                }
                            });
                            sourcesHtml += '</ul>';
                            sourcesArea.innerHTML = sourcesHtml;
                        } else {
                            sourcesArea.innerHTML = 'Fuentes consultadas: No se encontraron fuentes específicas para citar.';
                        }
                        
                    } else {
                        resultText.innerHTML = '<span class="text-red-600 font-bold">Error Doctrinal:</span> No se pudo generar una clarificación concisa para este concepto. Por favor, intente con una formulación diferente.';
                        sourcesArea.innerHTML = '';
                    }

                } catch (error) {
                    console.error('Error al llamar a la API de Gemini para Clarificación:', error);
                    resultText.innerHTML = '<span class="text-red-600 font-bold">Error del Sistema:</span> Ha ocurrido un fallo en la consulta LegalTech. Verifique la conexión o intente más tarde.';
                    sourcesArea.innerHTML = '';
                } finally {
                    loadingIndicator.classList.add('hidden');
                    resultArea.classList.remove('hidden');
                    clarifyButton.disabled = false;
                }
            };
            
            // ************ Función: Generar Solicitud Formal ************
            const generateFormalRequest = async () => {
                const topic = requestTopic.value;
                const details = requestDetails.value.trim();

                if (!topic || !details) {
                    draftText.textContent = 'Error: Debe seleccionar un tema y proporcionar detalles del caso para generar el borrador.';
                    draftResultArea.classList.remove('hidden');
                    return;
                }

                draftResultArea.classList.add('hidden');
                draftLoadingIndicator.classList.remove('hidden');
                draftButton.disabled = true;

                // User Query for Drafting
                const userQuery = `Redacta un borrador de solicitud de dictamen. Tema Principal: ${topic}. Detalles del caso: ${details}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    // NO Google Search grounding here, response must be based purely on user input and system prompt
                    systemInstruction: {
                        parts: [{ text: draftingSystemPrompt }]
                    },
                };

                try {
                    const response = await withBackoff(async () => {
                        return await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        // Limpiar y formatear el texto
                        draftText.textContent = text.trim();
                    } else {
                        draftText.textContent = 'Error de Redacción: No se pudo generar el borrador. Intente con detalles más específicos.';
                    }

                } catch (error) {
                    console.error('Error al llamar a la API de Gemini para Redacción:', error);
                    draftText.textContent = 'Error del Sistema: Ha ocurrido un fallo en la redacción LegalTech. Verifique la conexión o intente más tarde.';
                } finally {
                    draftLoadingIndicator.classList.add('hidden');
                    draftResultArea.classList.remove('hidden');
                    draftButton.disabled = false;
                }
            };

            // ************ Función: Copiar al Portapapeles ************
            const copyDraftToClipboard = () => {
                const textToCopy = draftText.textContent;
                
                // Crea un área de texto temporal para la copia
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = textToCopy;
                document.body.appendChild(tempTextArea);
                
                // Selecciona el texto
                tempTextArea.select();
                tempTextArea.setSelectionRange(0, 99999); // Para móviles
                
                try {
                    // Ejecuta el comando de copia (Funciona en iframes)
                    document.execCommand('copy');
                    
                    // Feedback visual simple (sustituir el texto del botón temporalmente)
                    const originalText = copyDraftButton.textContent;
                    copyDraftButton.textContent = '¡Copiado!';
                    setTimeout(() => {
                        copyDraftButton.textContent = originalText;
                    }, 1500);

                } catch (err) {
                    // Manejo de errores si la copia falla
                    console.error('Error al intentar copiar:', err);
                    alert('No se pudo copiar el texto automáticamente. Por favor, cópielo manualmente.');
                }
                
                document.body.removeChild(tempTextArea);
            };


            // ************ Event Listeners ************
            clarifyButton.addEventListener('click', getClarification);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    getClarification();
                }
            });

            draftButton.addEventListener('click', generateFormalRequest);
            copyDraftButton.addEventListener('click', copyDraftToClipboard);
        });
    </script>

</body>
</html>
